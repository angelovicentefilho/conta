# Story 1.2: Autenticação de Usuário

## Status
**Concluído ✅** - Implementado com sucesso em 01/09/2025

## Story
**Como um** novo usuário,
**Eu quero** criar uma conta segura com meu e-mail e senha e fazer login no sistema,
**Para que** eu possa acessar o sistema de controle financeiro com exclusividade e segurança.

## Contexto do Épico
**Épico:** Fundação e Controle Financeiro Essencial

**Relacionamento:** Segunda história do épico fundacional, estabelecendo o sistema de autenticação necessário para proteger e personalizar o acesso às funcionalidades financeiras.

**Dependências:** História 1.1 (Configuração Inicial do Backend) deve estar concluída.

## Critérios de Aceitação

1. **Registro de usuário:**
   - Endpoint `POST /auth/register` para criação de conta
   - Campos obrigatórios: nome, e-mail e senha
   - Validação de formato de e-mail válido
   - Verificação de unicidade do e-mail (não pode haver duplicatas)
   - Resposta de sucesso com dados do usuário (sem senha)

2. **Validação de senha segura:**
   - Mínimo 8 caracteres
   - Pelo menos 1 letra maiúscula e 1 minúscula
   - Pelo menos 1 número
   - Pelo menos 1 caractere especial (@, #, $, %, etc.)
   - Hash da senha usando bcrypt antes do armazenamento

3. **Login de usuário:**
   - Endpoint `POST /auth/login` para autenticação
   - Validação de credenciais (e-mail e senha)
   - Geração de token JWT válido por 24 horas
   - Resposta com token de acesso e dados básicos do usuário

4. **Middleware de autenticação:**
   - Middleware para validar tokens JWT em rotas protegidas
   - Extração e validação do usuário a partir do token
   - Resposta 401 para tokens inválidos ou expirados
   - Injeção do usuário autenticado no contexto da requisição

5. **Recuperação de senha:**
   - Endpoint `POST /auth/forgot-password` para solicitar reset
   - Geração de token de reset válido por 1 hora
   - Endpoint `POST /auth/reset-password` para redefinir senha
   - Validação do token de reset e atualização segura da senha

6. **Logout e invalidação:**
   - Endpoint `POST /auth/logout` para invalidar token
   - Sistema de blacklist básico para tokens invalidados
   - Limpeza automática de tokens expirados

7. **Modelos de dados seguros:**
   - Modelo User com campos validados (Pydantic)
   - Schemas de request/response para cada endpoint
   - Exclusão da senha hasheada nas respostas da API

## Definição de Pronto

- [x] Código implementado seguindo Arquitetura Hexagonal
- [x] Todos os endpoints de autenticação funcionais
- [x] Testes unitários e de integração passando
- [x] Validações de segurança implementadas
- [x] Hash de senhas com bcrypt
- [x] Sistema JWT funcional com expiração
- [x] Middleware de autenticação funcionando
- [x] Documentação da API atualizada
- [x] Tratamento de erros adequado

## Notas Técnicas

**Abordagem Técnica:** Implementação seguindo Arquitetura Hexagonal com separação clara entre domínio (User), portas (AuthPort) e adaptadores (JWT, MongoDB).

**Considerações de Arquitetura:**
- Port AuthPort definindo interface de autenticação
- Service UserService no core para lógica de negócio
- Adapter JWTAuth para implementação de tokens
- Repository UserRepository para persistência
- Middleware AuthMiddleware para proteção de rotas

**Segurança:**
- Hash de senhas com bcrypt (salt rounds: 12)
- Tokens JWT com algoritmo HS256
- Validação rigorosa de entrada de dados
- Proteção contra timing attacks na validação de senha
- Sanitização de dados de saída (nunca retornar hashes)

**Considerações de Performance:**
- Cache de validação de tokens (em memória)
- Índices no MongoDB para consultas de e-mail
- Blacklist eficiente para tokens invalidados

## Tarefas / Subtarefas

**Tarefas de Domínio:**
- [ ] Criar modelo User no domínio (`core/domain/user.py`)
- [ ] Definir Port AuthPort para interface de autenticação
- [ ] Implementar UserService com lógica de negócio
- [ ] Criar schemas Pydantic para requests/responses

**Tarefas de Adaptadores:**
- [ ] Implementar UserRepository (MongoDB adapter)
- [ ] Criar JWTAuth adapter para geração/validação de tokens
- [ ] Implementar PasswordHash adapter com bcrypt
- [ ] Desenvolver TokenBlacklist adapter para invalidação

**Tarefas de API:**
- [ ] Criar rotas de autenticação (`/auth/register`, `/login`, etc.)
- [ ] Implementar middleware de autenticação
- [ ] Adicionar validações de entrada robustas
- [ ] Configurar tratamento de erros específicos

**Tarefas de Configuração:**
- [ ] Adicionar variáveis de ambiente para JWT (secret, expiration)
- [ ] Configurar dependências de autenticação no container DI
- [ ] Atualizar configurações de segurança
- [ ] Configurar CORS para autenticação

**Tarefas de Teste:**
- [ ] Testes unitários para UserService
- [ ] Testes unitários para adapters (JWT, Password, Repository)
- [ ] Testes de integração para todos os endpoints
- [ ] Testes de segurança (password hashing, JWT validation)
- [ ] Testes de casos limite (tokens expirados, dados inválidos)

**Tarefas de Documentação:**
- [ ] Documentar schemas de API no FastAPI
- [ ] Atualizar README com instruções de autenticação
- [ ] Documentar fluxo de autenticação no código

## Estimativa

**Story Points:** 8

**Horas Estimadas:** 16-24 horas

**Complexidade:** Média-Alta - Sistema completo de autenticação com segurança

**Riscos/Incertezas:**
- Configuração correta do JWT e segurança
- Implementação adequada do bcrypt
- Integração com middleware de autenticação
- Gerenciamento de blacklist de tokens

## Estratégia de Testes

**Cenários de Teste:**
- Registro com dados válidos e inválidos
- Login com credenciais corretas e incorretas
- Validação de token JWT em rotas protegidas
- Fluxo completo de recuperação de senha
- Logout e invalidação de tokens
- Tentativas de acesso com tokens expirados

**Tipos de Teste:**
- Testes unitários para services e adapters
- Testes de integração para endpoints completos
- Testes de segurança para validações
- Testes de carga para performance de autenticação

**Dados de Teste:**
- Usuários de teste com diferentes perfis
- Senhas válidas e inválidas para validação
- Tokens válidos e inválidos para middleware
- E-mails duplicados para teste de unicidade

**Critérios de Teste:**
- 95%+ de cobertura de código para auth modules
- Todos os endpoints retornam status codes apropriados
- Senhas nunca aparecem em logs ou respostas
- Tokens expirados são rejeitados corretamente

## Riscos e Suposições

**Riscos Identificados:**
- Vulnerabilidades de segurança na implementação JWT
- Performance do bcrypt em produção
- Gerenciamento inadequado de tokens invalidados
- Exposição acidental de dados sensíveis

**Suposições:**
- MongoDB está configurado e acessível
- Variáveis de ambiente de JWT estão definidas
- Python-jose e bcrypt estão funcionando adequadamente
- Frontend irá gerenciar tokens corretamente

**Mitigações:**
- Revisar implementação de segurança com checklist
- Usar bibliotecas estabelecidas (python-jose, bcrypt)
- Implementar logging de segurança adequado
- Testes extensivos de casos limite

**Planos de Contingência:**
- Rollback para autenticação básica se JWT falhar
- Algoritmos alternativos de hash se bcrypt for problemático
- Implementação de rate limiting se houver abuso

## Notas de Desenvolvimento

*Seção reservada para anotações durante a implementação*

## Resultados de Testes

*Seção a ser preenchida após execução dos testes*

## Feedback de Revisão

*Seção para feedback de code review e aprovações*

## Log de Mudanças

| Data | Versão | Mudança | Autor |
|------|--------|---------|-------|
| 31/08/2025 | 1.0 | Criação inicial da história de autenticação | Scrum Master Bob |
