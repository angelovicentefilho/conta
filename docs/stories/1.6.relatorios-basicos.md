# Story 1.6: Relatórios Básicos

## Status
**Rascunho**

## Story
**Como um** usuário autenticado,
**Eu quero** gerar e exportar relatórios financeiros detalhados e personalizados,
**Para que** eu possa analisar meus gastos profundamente, identificar padrões, e tomar decisões financeiras embasadas em dados históricos.

## Contexto do Épico
**Épico:** Fundação e Controle Financeiro Essencial

**Relacionamento:** **HISTÓRIA FINAL** do épico fundacional, completando o sistema com capacidades analíticas avançadas que permitem análise histórica e exportação de dados para uso externo.

**Dependências:** 
- História 1.1 (Configuração Inicial do Backend) deve estar concluída
- História 1.2 (Autenticação de Usuário) deve estar concluída
- História 1.3 (Gestão de Contas Financeiras) deve estar concluída
- História 1.4 (Registro de Transações) deve estar concluída
- História 1.5 (Dashboard Principal) deve estar concluída

## Critérios de Aceitação

1. **Extrato detalhado por período:**
   - Endpoint `GET /api/v1/reports/statement` para extrato completo
   - Parâmetros: data_inicio, data_fim, account_ids (opcional), formato (json/csv/pdf)
   - Listagem cronológica de todas as transações no período
   - Dados: data, descrição, categoria, conta, valor, tipo, saldo acumulado
   - Totalizadores: saldo inicial, total receitas, total despesas, saldo final

2. **Relatório de despesas por categoria:**
   - Endpoint `GET /api/v1/reports/expenses-by-category` para análise categórica
   - Parâmetros: data_inicio, data_fim, include_subcategories, formato
   - Agregação de despesas agrupadas por categoria principal
   - Dados: categoria, valor total, número de transações, percentual do total
   - Comparação com período anterior (variação absoluta e percentual)
   - Ranking das categorias com maior gasto

3. **Relatório de receitas por fonte:**
   - Endpoint `GET /api/v1/reports/income-by-category` para análise de receitas
   - Parâmetros similares ao relatório de despesas
   - Agregação de receitas por categoria/fonte
   - Análise de consistência e variabilidade das receitas
   - Identificação de fontes principais vs esporádicas

4. **Exportação em PDF:**
   - Geração de PDFs profissionais com layout formatado
   - Cabeçalho com logo, período, dados do usuário
   - Tabelas organizadas com totalizadores
   - Gráficos incorporados (pizza para categorias, linha para evolução)
   - Rodapé com data de geração e assinatura digital

5. **Exportação em CSV:**
   - Formato padronizado para análise em planilhas
   - Headers descritivos em português
   - Dados formatados adequadamente (datas, valores monetários)
   - Encoding UTF-8 para caracteres especiais
   - Separadores configuráveis (vírgula/ponto-e-vírgula)

6. **Relatórios comparativos:**
   - Endpoint `GET /api/v1/reports/comparative` para análise temporal
   - Comparação entre dois períodos similares
   - Métricas: variação de gastos, mudanças de padrão, categorias emergentes
   - Análise de tendências (crescimento/decréscimo por categoria)
   - Alertas automáticos para mudanças significativas

7. **Relatórios personalizados:**
   - Endpoint `POST /api/v1/reports/custom` para relatórios sob demanda
   - Parâmetros flexíveis: contas específicas, categorias, filtros avançados
   - Templates predefinidos: "Análise Mensal", "Controle de Orçamento", "Fluxo de Caixa"
   - Agendamento básico para relatórios recorrentes
   - Histórico de relatórios gerados com cache

## Definição de Pronto

- [x] Código implementado seguindo Arquitetura Hexagonal
- [x] Todos os endpoints de relatórios funcionais
- [x] Sistema de exportação PDF e CSV implementado
- [x] Agregações complexas otimizadas
- [x] Performance adequada para grandes volumes
- [x] Testes unitários e de integração passando
- [x] Validações de segurança e autorização
- [x] Documentação da API atualizada no FastAPI
- [x] Cache de relatórios implementado
- [x] Logs de auditoria para exportações

## Notas Técnicas

**Abordagem Técnica:** Implementação de sistema completo de relatórios com agregações avançadas, exportação multi-formato e cache inteligente.

**Considerações de Arquitetura:**
- Service ReportService para orchestração de relatórios
- Service ExportService para geração de PDF/CSV
- Service AnalyticsService para cálculos comparativos
- Repository ReportRepository com agregações especializadas
- Factory ReportFactory para diferentes tipos de relatório
- Queue System para relatórios pesados (assíncrono)

**Exportação e Formatação:**
```python
# Estrutura para exportação PDF
class PDFReportGenerator:
    def generate_statement(self, data: StatementData) -> bytes:
        # ReportLab para geração profissional
        # Template com header, tabelas, gráficos, footer
        
class CSVReportExporter:
    def export_transactions(self, transactions: List[Transaction]) -> str:
        # Pandas para manipulação eficiente
        # Formatação monetária e datas localizadas
```

**Agregações Avançadas:**
- Pipeline MongoDB para análises temporais complexas
- Cálculos de tendências com algoritmos estatísticos
- Comparações percentuais e variações
- Detecção automática de outliers
- Métricas de consistência e variabilidade

**Cache e Performance:**
- Cache de relatórios frequentes com TTL inteligente
- Geração assíncrona para relatórios pesados
- Paginação para datasets grandes
- Compressão de arquivos grandes
- Queue system para processamento background

**Segurança:**
- Validação rigorosa de períodos e filtros
- Watermark nos PDFs com dados do usuário
- Logs de auditoria para todas as exportações
- Rate limiting para prevenção de abuso
- Sanitização de dados para exportação

## Tarefas / Subtarefas

**Tarefas de Domínio:**
- [ ] Criar DTOs para diferentes tipos de relatório (`core/domain/dto/reports.py`)
- [ ] Definir interfaces para geração e exportação
- [ ] Implementar ReportCalculator com algoritmos estatísticos
- [ ] Criar Port ReportPort para interface de dados
- [ ] Implementar ReportService com lógica de orchestração

**Tarefas de Serviços:**
- [ ] Implementar ExportService para PDF e CSV
- [ ] Criar StatisticalAnalysisService para cálculos avançados
- [ ] Implementar ComparativeAnalysisService para análises temporais
- [ ] Desenvolver ReportTemplateService para templates predefinidos
- [ ] Criar AsyncReportService para relatórios pesados

**Tarefas de Adaptadores:**
- [ ] Implementar ReportRepository com agregações MongoDB
- [ ] Configurar ReportLab para geração profissional de PDFs
- [ ] Implementar CSVExporter com Pandas
- [ ] Criar sistema de cache para relatórios
- [ ] Desenvolver queue system para processamento assíncrono

**Tarefas de API:**
- [ ] Criar schemas Pydantic para requests de relatórios
- [ ] Implementar ReportController com todos os endpoints
- [ ] Adicionar validações de parâmetros temporais
- [ ] Configurar streaming de arquivos grandes
- [ ] Implementar rate limiting específico para relatórios

**Tarefas de Exportação:**
- [ ] Desenvolver templates PDF profissionais
- [ ] Implementar geração de gráficos em PDFs
- [ ] Criar formatação CSV padronizada
- [ ] Configurar watermarks e assinaturas digitais
- [ ] Implementar compressão para arquivos grandes

**Tarefas de Agregação:**
- [ ] Criar pipeline MongoDB para extrato detalhado
- [ ] Implementar agregação de despesas por categoria
- [ ] Desenvolver análise comparativa entre períodos
- [ ] Criar cálculos de tendências e variações
- [ ] Implementar detecção de padrões anômalos

**Tarefas de Cache e Performance:**
- [ ] Configurar cache Redis para relatórios frequentes
- [ ] Implementar geração assíncrona para relatórios pesados
- [ ] Criar sistema de notificação para relatórios prontos
- [ ] Desenvolver otimizações para grandes volumes
- [ ] Implementar pré-cálculo de métricas comuns

**Tarefas de Teste:**
- [ ] Testes unitários para ReportService
- [ ] Testes unitários para ExportService
- [ ] Testes de geração de PDF e CSV
- [ ] Testes de agregações complexas
- [ ] Testes de performance para grandes volumes
- [ ] Testes de integridade de dados exportados
- [ ] Testes de cache e invalidação
- [ ] Testes de segurança para exportações

**Tarefas de Configuração:**
- [ ] Configurar dependências para PDF (ReportLab)
- [ ] Configurar queue system (Celery/Redis)
- [ ] Configurar templates de relatórios
- [ ] Configurar logs de auditoria
- [ ] Adicionar métricas de uso de relatórios

**Tarefas de Documentação:**
- [ ] Documentar todos os endpoints no FastAPI
- [ ] Criar exemplos de relatórios para cada tipo
- [ ] Documentar formatos de exportação
- [ ] Atualizar README com funcionalidades de relatórios
- [ ] Criar guia de uso para templates

## Estimativa

**Story Points:** 13

**Horas Estimadas:** 32-40 horas

**Complexidade:** Muito Alta - Sistema completo de relatórios, exportação multi-formato, agregações complexas

**Riscos/Incertezas:**
- Performance de agregações com grandes volumes
- Complexidade da geração profissional de PDFs
- Gestão de memória para relatórios grandes
- Otimização de queries MongoDB complexas

## Estratégia de Testes

**Cenários de Teste:**
- Geração de extrato com grandes volumes de transações
- Exportação PDF com formatação profissional
- Exportação CSV com dados corretos e formatados
- Análise comparativa entre diferentes períodos
- Performance de agregações complexas
- Cache de relatórios frequentes
- Geração assíncrona de relatórios pesados
- Validação de integridade de dados exportados

**Tipos de Teste:**
- Testes unitários para services e calculators
- Testes de integração para fluxos completos
- Testes de performance para volumes altos
- Testes de qualidade para PDFs gerados
- Testes de precisão para agregações
- Testes de cache e sistema assíncrono

**Dados de Teste:**
- Usuários com histórico extenso (1+ anos)
- Múltiplas contas e categorias diversificadas
- Volumes altos para testes de performance
- Cenários edge cases para validação
- Dados comparativos para análises temporais

**Critérios de Teste:**
- 95%+ de cobertura para report modules
- Performance < 2s para relatórios normais, < 30s para pesados
- PDFs gerados com qualidade profissional
- CSVs importáveis em Excel/Google Sheets
- Zero inconsistências em dados exportados

## Riscos e Suposições

**Riscos Identificados:**
- Performance crítica com volumes muito altos
- Complexidade excessiva da geração de PDFs
- Uso excessivo de memória para relatórios grandes
- Problemas de encoding em exportações CSV

**Suposições:**
- Usuários não gerarão relatórios com mais de 100K transações
- ReportLab adequado para PDFs profissionais
- MongoDB suporta agregações complexas eficientemente
- Redis adequado para cache de relatórios

**Mitigações:**
- Implementar paginação e streaming para grandes volumes
- Geração assíncrona para relatórios pesados
- Otimização agressiva de queries e índices
- Fallbacks para formatos simples se complexos falharem

**Planos de Contingência:**
- Simplificação de PDFs se geração for muito complexa
- Relatórios em lotes se performance for crítica
- Cache mais agressivo se necessário

## Notas de Desenvolvimento

*Seção reservada para anotações durante a implementação*

## Resultados de Testes

*Seção a ser preenchida após execução dos testes*

## Feedback de Revisão

*Seção para feedback de code review e aprovações*

## Log de Mudanças

| Data | Versão | Mudança | Autor |
|------|--------|---------|-------|
| 31/08/2025 | 1.0 | Criação inicial da história de relatórios básicos | Scrum Master Bob |
