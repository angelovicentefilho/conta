# Story 2.2: Gestão de Orçamentos Mensais

## Status
**Rascunho**

## Story
**Como um** usuário autenticado,
**Eu quero** definir orçamentos mensais por categoria de despesa,
**Para que** eu possa controlar meus gastos e garantir que não estou excedendo meus limites financeiros.

## Contexto do Épico
**Épico:** Funcionalidades Avançadas de Planejamento

**Relacionamento:** Esta é a segunda história do épico de planejamento, permitindo que os usuários gerenciem seus gastos de forma proativa.

**Dependências:**
- História 1.2 (Autenticação de Usuário) deve estar concluída.
- História 1.4 (Registro de Transações) deve estar concluída para que os gastos possam ser comparados com o orçamento.

## Critérios de Aceitação

1.  **Criação/Atualização de Orçamento:**
    -   Endpoint `POST /api/v1/budgets` para criar ou atualizar um orçamento (upsert).
    -   Campos obrigatórios: `categoryId`, `amount`, `month` (formato YYYY-MM).
    -   Deve haver um índice único para `(userId, categoryId, month)` para evitar duplicatas.
    -   Validação para garantir que `amount` seja positivo.
    -   Validação para garantir que a `categoryId` exista e pertença ao usuário (ou seja uma categoria do sistema).

2.  **Listagem de Orçamentos por Mês:**
    -   Endpoint `GET /api/v1/budgets` para listar os orçamentos de um mês específico.
    -   Parâmetro de query obrigatório: `month` (formato YYYY-MM).
    -   A resposta deve incluir `id`, `categoryId`, `categoryName`, `amount`, e `month`.

3.  **Exclusão de Orçamento:**
    -   Endpoint `DELETE /api/v1/budgets/{budget_id}` para excluir um orçamento.
    -   Validação de propriedade do orçamento.
    -   Resposta 204 No Content em caso de sucesso.

4.  **Visualização do Status do Orçamento (Opcional, mas recomendado):**
    -   Ao listar os orçamentos, a API poderia incluir o total gasto naquela categoria no mês para fácil comparação.
    -   Ex: `{ "id": "...", "categoryName": "Alimentação", "amount": "800.00", "spent": "550.00", "remaining": "250.00" }`

## Definição de Pronto

- [ ] Código implementado seguindo a Arquitetura Hexagonal.
- [ ] Todos os endpoints de orçamentos (upsert, list, delete) estão funcionais.
- [ ] Testes unitários e de integração para o serviço e repositório de orçamentos estão passando.
- [ ] Validações de segurança e de negócio estão implementadas.
- [ ] Documentação da API (Swagger/OpenAPI) está atualizada.

## Notas Técnicas

**Modelo de Dados (`budgets`):**
```json
{
  "_id": "ObjectId",
  "userId": "ObjectId",
  "categoryId": "ObjectId",
  "amount": "Decimal128",
  "month": "ISODate", // Armazenar como o primeiro dia do mês
  "createdAt": "ISODate",
  "updatedAt": "ISODate"
}
```

**Abordagem Técnica:**
-   Implementar `BudgetService` no core.
-   Implementar `BudgetRepository` como um adaptador de saída para o MongoDB.
-   Criar `budget_controller.py` para a API.
-   O serviço de orçamento precisará interagir com o `TransactionRepository` para calcular os gastos atuais por categoria.